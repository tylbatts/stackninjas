
services:
  keycloak:
    image: quay.io/keycloak/keycloak:22.0
    container_name: keycloak
    command:
      - start-dev
      - --import-realm
    ports:
      - "8081:8080"
    environment:
      KEYCLOAK_ADMIN: "admin"
      KEYCLOAK_ADMIN_PASSWORD: "admin"
      KEYCLOAK_IMPORT: "/opt/keycloak/data/import/realm-export.json"
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    networks:
      - stackninjas-net
  
  
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api
    ports:
      - "8080:8080"
    environment:
      KEYCLOAK_REALM: "stackninjas"
      # Point to Keycloak service on the Docker network (new Quarkus image uses root context)
      KEYCLOAK_URL: "http://keycloak:8080"
      KEYCLOAK_CLIENT_ID: "api"
      QDRANT_URL: "http://qdrant:6333"
      QDRANT_COLLECTION: "stackninjas"
      QDRANT_WORKFLOW_COLLECTION: "workflow_suggestions"
      EMBED_API_URL: "http://embedder:8000"
      # Database connection string for Postgres (DB service)
      DATABASE_DSN: "host=db user=postgres password=postgres dbname=stackninjas port=5432 sslmode=disable TimeZone=UTC"
    depends_on:
      - keycloak
      - qdrant
      - embedder
      - db
    networks:
      - stackninjas-net

  ui:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: "http://localhost:8080"
        # Front-end should use host-mapped port for Keycloak without /auth
        VITE_KEYCLOAK_URL: "http://localhost:8081"
        VITE_KEYCLOAK_REALM: "stackninjas"
        VITE_KEYCLOAK_CLIENT_ID: "frontend"
    container_name: ui
    ports:
      - "80:80"
    environment:
      VITE_API_URL: "http://localhost:8080"
      VITE_KEYCLOAK_URL: "http://localhost:8081"
      VITE_KEYCLOAK_REALM: "stackninjas"
      VITE_KEYCLOAK_CLIENT_ID: "frontend"
    depends_on:
      - api
    networks:
      - stackninjas-net

  embedder:
    build:
      context: .
      dockerfile: Dockerfile.embed
    container_name: embedder
    ports:
      - "8000:8000"
    environment:
      QDRANT_URL: "http://qdrant:6333"
    depends_on:
      - qdrant
    networks:
      - stackninjas-net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - stackninjas-net



volumes:
  qdrant_data:
  db_data:

networks:
  stackninjas-net:
    driver: bridge