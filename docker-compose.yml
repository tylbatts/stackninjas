
services:
  db:
    image: postgres:13
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: stackninjas
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command:
      - start-dev
      - --import-realm
      - -Dkeycloak.cookie.secure=false
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports:
      - '8080:8080'

  backend:
    build: ./backend
    command: uvicorn app.main:app --host 0.0.0.0 --reload
    volumes:
      - ./backend/app:/app/app
    ports:
      - '8000:8000'
    depends_on:
      - db
      - keycloak
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db/stackninjas
      SECRET_KEY: supersecretkey
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: '30'
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: stackninjas
      KEYCLOAK_CLIENT_ID: frontend
      QDRANT_HOST: qdrant
      QDRANT_PORT: '6333'
      EMBEDDING_MODEL_NAME: distilbert-base-uncased

  frontend:
    build: ./frontend
    command: npm run dev -- --host 0.0.0.0
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - '5173:5173'
    environment:
      # Backend API base path for admin routes
      VITE_API_BASE_URL: http://localhost:8000/admin
      # Keycloak settings for the Admin React app
      VITE_KEYCLOAK_URL: http://localhost:8080
      VITE_KEYCLOAK_REALM: stackninjas
      VITE_KEYCLOAK_CLIENT_ID: frontend
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - '6333:6333'
    volumes:
      - qdrant_storage:/qdrant/storage

volumes:
  postgres_data:
  qdrant_storage: